<!DOCTYPE html>
<html>
<head>
  <title>Rutomatrix</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #121212;
      color: #FFFFFF;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .audio-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      gap: 16px;
      max-width: 2000px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #1E1E1E;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .device-info {
      display: flex;
      flex-direction: column;
    }

    .device-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #device-timer {
      margin-left: 10px;
    }

    .device-name {
      font-size: 18px;
      font-weight: 600;
      color: #FF6A00;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      word-break: break-word;
      line-height: 1.2;
      text-align: center;
    }

    .no-feed {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #BBBBBB; 
    font-size: 16px;
    text-align: center;
    }

    .no-feed p {
      margin-bottom: 20px;
    }

    .connect-btn1 {
      padding: 10px 20px;
      background-color: #ff6a00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .connect-btn1:hover {
      background-color: #2980b9;
    }

    .audio-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .audio-viewer-container {
      flex: 1;
      background: #1E1E1E;
      border: groove 1px #7c7c7c;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .audio-viewer-header {
      padding: 8px 12px;
      background: rgba(0,0,0,0.3);
      font-size: 14px;
    }

    .audio-viewer-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .audio-visualization {
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 10px;
      width: 100%;
    }

    .audio-visualization canvas {
      width: 100%;
      height: 150px;
      display: block;
    }

    .progress-container {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      cursor: pointer;
      margin-bottom: 15px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: #0074c2;
      border-radius: 2px;
      transition: width 0.1s linear;
    }

    .time-display {
      display: flex;
      justify-content: flex-end;
      margin-top: 5px;
      font-weight: 500;
      font-size: 14px;
      color: #cfcfcfff;
    }

    .audio-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
    }

    .play-button {
      background: none;
      border: none;
      font-size: 20px;
      color: #0074c2;
      cursor: pointer;
      padding: 8px;
    }

    .volume-container {
      display: flex;
      align-items: center;
      position: relative;
      margin-right: 90px;
    }

    .volume-icon {
      background: none;
      border: none;
      font-size: 20px;
      color: #0074c2;
      cursor: pointer;
      padding: 8px;
    }

    .volume-slider {
      position: absolute;
      flex-grow: 1;
      bottom: 17px;
      left: 40px;
      width: 100px;
      height: 6px;
      transform-origin: right bottom;
      background: #e0e0e0;
      border-radius: 3px;
      -webkit-appearance: none;
    }

    .volume-text {
      position: absolute;
      top: 35px;
      right: 0;
      font-size: 12px;
      color: #0074c2;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #0074c2;
      cursor: pointer;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #audio-source-select {
      padding: 6px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #1E1E1E;
      color: #fff;
    }
    #header-connect-btn[disabled] {
      background-color: #555;
      cursor: not-allowed;
    }

    .stream-container1 {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .connection-status {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 14px;
      color: #f0f0f0ff;
    }

  </style>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>

<body>
<div class="audio-container">
  <div class="header">
    <div class="device-info">
      <div class="device-name-row">
        <div class="device-name">${device.name}</div>
        <div id="device-timer">--:--:--</div>
      </div>
    </div>
    <div class="header-controls">
      <select id="audio-source-select">
        <option value="">Select Source</option>
        <option value="HDMI">HDMI</option>
        <option value="Bluetooth">Bluetooth</option>
      </select>
      <button id="header-connect-btn" class="connect-btn1" disabled>Connect to Stream</button>
    </div>
  </div>

  <div class="audio-content">
    <div class="audio-viewer-container">
      <div class="audio-viewer-header">
        <span>Audio Stream</span>
      </div>
      <div class="audio-viewer-content">
        <div id="root"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

const AudioStreamPage = () => {
  const [selectedSource, setSelectedSource] = useState("");
  const [isConnected, setIsConnected] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [volume, setVolume] = useState(50);
  const [isMuted, setIsMuted] = useState(false);
  const [showVolumeSlider, setShowVolumeSlider] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(300); // 5 minutes default
  const [streamUrl, setStreamUrl] = useState("");
  const [connectionStatus, setConnectionStatus] = useState("Disconnected");

  const audioRef = useRef(null);
  const canvasRef = useRef(null);
  const animationRef = useRef(null);
  const progressRef = useRef(null);
  const playIntervalRef = useRef(null);

  const formatTime = time => {
    const hours = Math.floor(time / 3600);
    const minutes = Math.floor((time % 3600) / 60);
    const seconds = Math.floor(time % 60);
    
    if (hours > 0) {
      return (
        hours + ":" +
        (minutes < 10 ? "0" : "") + minutes + ":" +
        (seconds < 10 ? "0" : "") + seconds
      );
    }
    return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
  };

  const startPlayback = () => {
    // Start playback timer
    playIntervalRef.current = setInterval(() => {
      setCurrentTime(prevTime => {
        if (prevTime >= duration) {
          clearInterval(playIntervalRef.current);
          setIsPlaying(false);
          return duration;
        }
        return prevTime + 1;
      });
    }, 1000);
    
    // Start visualization animation
    simulateAudioData();
    
    if (audioRef.current) {
      audioRef.current.play().catch(e => console.error("Play error:", e));
    }
    
    setIsPlaying(true);
  };

  const stopPlayback = () => {
    // Stop playback timer
    clearInterval(playIntervalRef.current);
    cancelAnimationFrame(animationRef.current);
    
    if (audioRef.current) {
      audioRef.current.pause();
    }
    
    setIsPlaying(false);
  };

  const handleConnect = async () => {
    const sourceDropdown = document.getElementById('audio-source-select');
    const selected = sourceDropdown && sourceDropdown.value || '';

    if (!selected) return;

    setSelectedSource(selected);
    setConnectionStatus("Connecting...");

    try {
      let apiUrl;
      if (selected === "HDMI") {
        apiUrl = "http://100.113.17.55:7123/audio";
      } else if (selected === "Bluetooth") {
        apiUrl = "YOUR_BLUETOOTH_ENDPOINT";
      }

      // Test connection
      const response = await fetch(apiUrl, { method: 'GET' });
      if (!response.ok) throw new Error("Connection failed");

      setStreamUrl(apiUrl);
      setIsConnected(true);
      setConnectionStatus("Connected");

      // Auto-start playback after short delay
      setTimeout(() => {
        if (audioRef.current) {
          audioRef.current.src = apiUrl;
          audioRef.current.volume = volume / 100;
        }
        startPlayback();
      }, 500);

    } catch (error) {
      console.error("Connection failed:", error);
      setConnectionStatus("Connection Failed");
      setIsConnected(false);
    }
  };

  const handlePlayPause = () => {
    if (!isConnected) return;
    
    if (isPlaying) {
      stopPlayback();
    } else {
      startPlayback();
    }
  };

  const handleVolumeChange = (e) => {
    const newVolume = parseInt(e.target.value);
    setVolume(newVolume);
    if (audioRef.current) {
      audioRef.current.volume = newVolume / 100;
      setIsMuted(newVolume === 0);
    }
    setTimeout(() => setShowVolumeSlider(false), 5000);
  };

  const handleProgressClick = (e) => {
    if (!isConnected) return;
    
    const rect = progressRef.current.getBoundingClientRect();
    const clickPosition = (e.clientX - rect.left) / rect.width;
    const newTime = clickPosition * duration;
    
    setCurrentTime(newTime);
    
    // If we were playing, reset the interval
    if (isPlaying) {
      clearInterval(playIntervalRef.current);
      playIntervalRef.current = setInterval(() => {
        setCurrentTime(prevTime => {
          if (prevTime >= duration) {
            clearInterval(playIntervalRef.current);
            setIsPlaying(false);
            return duration;
          }
          return prevTime + 1;
        });
      }, 1000);
    }
    
    if (audioRef.current) {
      audioRef.current.currentTime = newTime;
    }
  };

  const simulateAudioData = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    const width = canvas.width;
    const height = canvas.height;
    const barWidth = 4;
    const gap = 2;
    const totalBars = Math.floor(width / (barWidth + gap));

    ctx.clearRect(0, 0, width, height);

    for (let i = 0; i < totalBars; i++) {
      const isPlayed = (i / totalBars) < (currentTime / duration);
      const barHeight = (Math.sin(i + Date.now() / 200) + 1) / 2 * (height * 0.8);

      const x = i * (barWidth + gap);
      const y = (height - barHeight) / 2;
      ctx.fillStyle = isPlayed ? '#3498db' : '#ecf0f1';
      ctx.fillRect(x, y, barWidth, barHeight);
    }

    if (isPlaying) {
      animationRef.current = requestAnimationFrame(simulateAudioData);
    }
  };

  useEffect(() => {
    // Start or stop visualization based on play state
    if (isPlaying) {
      simulateAudioData();
    } else {
      cancelAnimationFrame(animationRef.current);
      const canvas = canvasRef.current;
      if (canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
    
    return () => cancelAnimationFrame(animationRef.current);
  }, [isPlaying, currentTime]);

  useEffect(() => {
    // Set canvas width based on container
    const resizeCanvas = () => {
      const canvas = canvasRef.current;
      if (canvas) {
        canvas.width = canvas.offsetWidth;
      }
    };
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    return () => {
      window.removeEventListener('resize', resizeCanvas);
      clearInterval(playIntervalRef.current);
      cancelAnimationFrame(animationRef.current);
    };
  }, []);

  return (
    <div className="stream-container1">
      <button id="react-connect-btn" style={{ display: 'none' }} onClick={handleConnect}>React Connect</button>

      {!isConnected ? (
        <div className="no-feed">
          <p>{connectionStatus}</p>
        </div>
      ) : (
        <>
          <div className="audio-feed">
            <div className="connection-status">
              <span>Connected to: {selectedSource}</span>
              <span>Status: {connectionStatus}</span>
            </div>
            
            <div className="audio-visualization">
              <canvas ref={canvasRef} width="600" height="150" />
            </div>

            <div className="progress-container" ref={progressRef} onClick={handleProgressClick}>
              <div
                className="progress-bar"
                style={{ width: `${(currentTime / duration) * 100}%` }}
              ></div>
            </div>
            
            <div className="time-display">
              <span>{formatTime(currentTime)}</span>
            </div>

            <div className="audio-controls">
              <button className="play-button" onClick={handlePlayPause}>
                {isPlaying ? <i className="fas fa-pause" /> : <i className="fas fa-play" />}
              </button>

              <div className="volume-container">
                <button
                  className="volume-icon"
                  onClick={(e) => {
                    e.stopPropagation();
                    setShowVolumeSlider(!showVolumeSlider);
                  }}
                >
                  {isMuted ? <i className="fas fa-volume-mute" /> : <i className="fas fa-volume-up" />}
                </button>

                {showVolumeSlider && (
                  <div>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={volume}
                      onChange={handleVolumeChange}
                      className="volume-slider"
                    />
                    <div className="volume-text">{volume}%</div>
                  </div>
                )}
              </div>
            </div>

            <audio ref={audioRef} loop src={streamUrl} />
          </div>
        </>
      )}
    </div>
  );
};

ReactDOM.render(<AudioStreamPage />, document.getElementById("root"));
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('audio-source-select');
  const btn = document.getElementById('header-connect-btn');

  select.addEventListener('change', () => {
    btn.disabled = select.value === '';
  });

  btn.addEventListener('click', () => {
    const connectBtn = document.getElementById('react-connect-btn');
    if (connectBtn) {
      connectBtn.click();
      const streamContainer = document.querySelector('.stream-container1');
      if (streamContainer) {
        streamContainer.scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
});
</script>
</body>
</html>